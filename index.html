<!DOCTYPE html>
<html>
<head>
  <title>Pusher Test</title>
  <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
  <script>
    let ablyClient, ablyChannel, auth0Client;
    
    window.onload = async function() {
      document.getElementById("logged_in").style.display = 'none';
      document.getElementById("not_logged_in").style.display = 'none';
      
      auth0Client = await auth0.createAuth0Client({
        domain: "dev-5z14lzlpjd7meucs.us.auth0.com",
        clientId: "zvl686e0L9ntJ6EkttXxxWIOugjYgqjT"
      });
      
      const isAuthenticated = await auth0Client.isAuthenticated();
      
      if (isAuthenticated) {
        return loadItUp();
      } 
      
      const query = window.location.search;
      if (query.includes("code=") && query.includes("state=")) {
        try {
          await auth0Client.handleRedirectCallback();
        } catch(e) {
          console.log(e);
          document.getElementById("loading").style.display = 'none';
          document.getElementById("not_logged_in").style.display = null;
          window.history.replaceState({}, document.title, "/");
          return;
        }
        
        window.history.replaceState({}, document.title, "/");
        return loadItUp();
      }
      
      document.getElementById("loading").style.display = 'none';
      document.getElementById("not_logged_in").style.display = null;
      return;
    };
    
    const loadItUp = async () => {
      document.getElementById("loading").style.display = 'none';
      document.getElementById("logged_in").style.display = null;
      document.getElementById(
        "ipt-access-token"
      ).innerHTML = await auth0Client.getTokenSilently();

      document.getElementById("ipt-user-profile").textContent = JSON.stringify(
        await auth0Client.getUser()
      );
      ablyClient = new Ably.Realtime.Promise('wUx-vg.uwFsQQ:4I_4x75mAaOBD2ips4g14v9NSEI1wvilxH_zvL_Nj8I');
      await ablyClient.connection.once('connected');
      ablyChannel = ablyClient.channels.get('quickstart');
      await ablyChannel.subscribe('greeting', (message) => {
        console.log('Received a greeting message in realtime: ' + message.data)
      });
    };
    
    const login = async () => {
      await auth0Client.loginWithRedirect({
        authorizationParams: {
          redirect_uri: window.location.origin
        }
      });
    };
    
    const logout = () => {
      auth0Client.logout({
        logoutParams: {
          returnTo: window.location.origin
        }
      });
    };
  </script>
</head>
<body>
  <h1>Chat It Up</h1>
  <hr>
  <div id="loading">Loading...</div>
  <div id="logged_in">
    <h3>You are logged in!</h3>
    <button id="btn-logout" onclick="logout()">Log out</button>
    <p>
      You're seeing this content because you're currently
      <strong>logged in</strong>.
    </p>
    <label>
      Access token:
      <pre id="ipt-access-token"></pre>
    </label>
    <label>
      User profile:
      <pre id="ipt-user-profile"></pre>
    </label>
  </div>
  <div id="not_logged_in">
    <h3>You are not yet logged in!</h3>
    <button id="btn-login" onclick="login()">Log in</button>
  </div>
</body>
</html>
