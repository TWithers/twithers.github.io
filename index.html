<!DOCTYPE html>
<html>
<head>
  <title>Pusher Test</title>
  <script src="https://js.pusher.com/7.2/pusher.min.js"></script>
  <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
  <script>

    // Enable pusher logging - don't include this in production
    Pusher.logToConsole = true;

    var pusher = new Pusher('06b53f218abe91debdaf', {
        cluster: 'mt1',
        channelAuthorization: {
          endpoint: "users.json"
        }
    });

    var channel = pusher.subscribe('private-chat-channel');
    channel.bind('my-event', function(data) {
      alert(JSON.stringify(data));
    });
  </script>
  <script>
    window.onload = async function() {
      document.getElementById("logged_in").style.display = 'none';
      document.getElementById("not_logged_in").style.display = 'none';
      
      auth0Client = await auth0.createAuth0Client({
        domain: "dev-5z14lzlpjd7meucs.us.auth0.com",
        clientId: "zvl686e0L9ntJ6EkttXxxWIOugjYgqjT"
      });
      
      const isAuthenticated = await auth0Client.isAuthenticated();
      
      if (isAuthenticated) {
        document.getElementById("loading").style.display = 'none';
        document.getElementById("logged_in").style.display = null;
        return;
      } 
      
      const query = window.location.search;
      if (query.includes("code=") && query.includes("state=")) {
        try {
          await auth0Client.handleRedirectCallback();
        } catch(e) {
          console.log(e);
          document.getElementById("loading").style.display = 'none';
          document.getElementById("not_logged_in").style.display = null;
          window.history.replaceState({}, document.title, "/");
          return;
        }
        
        document.getElementById("loading").style.display = 'none';
        document.getElementById("logged_in").style.display = null;
        window.history.replaceState({}, document.title, "/");
        return;
      }
      
      document.getElementById("loading").style.display = 'none';
      document.getElementById("not_logged_in").style.display = null;
      return;
    };
    
    const login = async () => {
      await auth0Client.loginWithRedirect({
        authorizationParams: {
          redirect_uri: window.location.origin
        }
      });
    };
    
    const logout = () => {
      auth0Client.logout({
        logoutParams: {
          returnTo: window.location.origin
        }
      });
    };
  </script>
</head>
<body>
  <h1>Chat It Up</h1>
  <hr>
  <div id="loading">Loading...</div>
  <div id="logged_in">
    <h3>You are logged in!</h3>
    <button id="btn-logout" onclick="logout()">Log out</button>
  </div>
  <div id="not_logged_in">
    <h3>You are not yet logged in!</h3>
    <button id="btn-login" onclick="login()">Log in</button>
  </div>
</body>
</html>
